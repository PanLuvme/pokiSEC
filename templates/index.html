<!DOCTYPE html>
<html>
<head>
    <title>pokiSEC Loader</title>
    <style>
        body { background: #0f172a; color: white; font-family: monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .drop-zone { border: 2px dashed #38bdf8; padding: 50px; text-align: center; border-radius: 10px; transition: 0.3s; width: 400px; }
        .drop-zone.dragover { background: #1e293b; border-color: #22c55e; }
        #progress-container { width: 100%; background: #333; margin-top: 20px; display: none; height: 10px; border-radius: 5px; }
        #progress-bar { width: 0%; height: 100%; background: #38bdf8; border-radius: 5px; transition: width 0.2s; }
        h1 { margin-bottom: 10px; }
        .note { font-size: 0.8em; color: #94a3b8; margin-top: 15px; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="drop-zone" id="drop-zone">
            <h1>ðŸ“¦ pokiSEC Setup</h1>
            <p>Drag your <b>.qcow2</b> disk image here.</p>
            <p class="note">Must be pre-converted (ARM64 for Mac, x64 for PC)</p>
        </div>
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
        <p id="status"></p>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            
            if (!file.name.endsWith('.qcow2')) {
                alert("Please upload a .qcow2 file!");
                return;
            }
            uploadFile(file);
        });

        function uploadFile(file) {
            document.getElementById('progress-container').style.display = 'block';
            status.innerText = "Starting Upload: " + file.name + "...";

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);
            const formData = new FormData();
            formData.append('file', file);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    
                    progressBar.style.width = percent + '%';

                    if (percent < 99) {
                        status.innerText = `Uploading to Container: ${Math.round(percent)}%`;
                    } else {
                        progressBar.style.backgroundColor = '#22c55e'; 
                        status.innerHTML = "<b>Network Transfer Complete.</b><br>Saving to Disk (Do NOT Close)...";
                    }
                }
            };

            xhr.onload = () => {
                if (xhr.status == 200) {
                    status.innerText = "Success! Booting Sandbox...";
                    // Wait 2 seconds for the server to die and QEMU to take over
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    status.innerText = "Error uploading. Check Docker stats.";
                    progressBar.style.backgroundColor = '#ef4444'; 
                }
            };
            xhr.send(formData);
        }
    </script>
</body>
</html>
